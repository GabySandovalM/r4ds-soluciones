# Visualización de datos

## Paquetes necesarios

```{r}
library(ggplot2)
library(datos)
```

## Primeros pasos

### Ejercicios

1. Corre `ggplot(data = millas)`. ¿Qué observas?

<div class="solucion">
<h3>Solución</h3>

```{r}
ggplot(data = millas)
```

Este código crea un gráfico vacío. Como no se han especificado las capas mediante `geom_*()`, no se dibuja sobre el fondo. 
</div>

2. ¿Cuántas filas hay en `millas`? ¿Cuántas columnas?

<div class="solucion">
<h3>Solución</h3>

Hay `r nrow(millas)` filas y `r ncol(millas)` columnas en `millas`.

```{r}
nrow(millas)
ncol(millas)
```
</div>

3. ¿Qué describe la variable `traccion`? Lee la ayuda de `?millas` para encontrar la respuesta.

<div class="solucion">
<h3>Solución</h3>

`traccion` esa una variable categórica que clasifica los vehículos en tracción delantera, trasera o de cuatro ruedas.

```{r}
unique(millas$traccion)
```
</div>

4. Realiza un gráfico de dispersión de `autopista` versus `cilindros`.

<div class="solucion">
<h3>Solución</h3>

```{r}
ggplot(millas, aes(x = autopista, y = cilindros)) +
  geom_point()
```
</div>

5. ¿Qué sucede cuando haces un gráfico de dispersión de `clase` versus `traccion`? ¿Por qué no es útil este gráfico?

<div class="solucion">
<h3>Solución</h3>

El gráfico resultante tiene pocos puntos. Ambas variables son categóricas y por lo tanto existe una cantidad limitada de combinaciones posibles.
```{r}
ggplot(millas, aes(x = clase, y = traccion)) +
  geom_point()
```

Otro problema es la frecuencia de combinaciones posibles no es la misma en todos los casos.
```{r}
count(millas, traccion, clase)
```

Los gráficos de dispersión debieran usarse con variables continuas y cuando los valores son únicos.
</div>

## Mapeos estéticos

### Ejercicios

1. ¿Qué no va bien en este código? ¿Por qué hay puntos que no son azules?

   ```{r}
   ggplot(data = millas) +
     geom_point(mapping = aes(x = motor, y = autopista, color = "blue"))
   ```

<div class="solucion">
<h3>Solución</h3>

Se incluyó el color dentro de `aes()`, por lo cual se trata como una variable, lo cual sería útil si tuvieramos una columna con información de los colores.

Para dejar todos los puntos en color azul, se debe cambiar el orden de los parámetros.
```{r}
ggplot(data = millas) +
     geom_point(mapping = aes(x = motor, y = autopista), color = "blue")
```
</div>

2. ¿Qué variables en `millas` son categóricas? ¿Qué variables son continuas? (Sugerencia: escribe `?millas` para leer la documentación de ayuda para este conjunto de datos). ¿Cómo puedes ver esta información cuando ejecutas `millas`?

<div class="solucion">
<h3>Solución</h3>

Variables categóricas: modelo, transmisión, tracción, combustible y clase.

Variables continuas: motor, año, cilindros, ciudad, autopista.
</div>

3. Asigna una variable continua a `color`, ` size`, y `shape`. ¿Cómo se comportan estas estéticas de manera diferente para variables categóricas y variables continuas?

<div class="solucion">
<h3>Solución</h3>

Una posibilidad es graficar rendimiento de combustible en autopista dado el tipo de motor. Como información adicional usamos el rendimiento en ciudad como color, de modo de contar con una paleta de colores informativa.

```{r}
ggplot(millas, aes(x = motor, y = autopista, colour = ciudad)) +
  geom_point()
```

Los otros casos quedan como ejercicio.
</div>

4. ¿Qué ocurre si asignas o mapeas la misma variable a múltiples estéticas?

<div class="solucion">
<h3>Solución</h3>

R va a generar un gráfico con información redundante, lo cual se debiera evitar.

```{r}
ggplot(millas, aes(x = motor, y = autopista, colour = autopista, size = autopista)) +
  geom_point()
```
</div>

5. ¿Qué hace la estética `stroke`? ¿Con qué formas trabaja? (Sugerencia: consultar `?geom_point`)

<div class="solucion">
<h3>Solución</h3>

Cambia el tamaño de los bordes de las formas 21 a 25. Para estas formas es posible cambiar el color de relleno y borde y también el tamaño de los bordes.

Ejemplo:
```{r}
ggplot(mtautos, aes(peso, millas)) +
  geom_point(shape = 21, colour = "black", fill = "white", size = 5, stroke = 5)
```
</div>

6. ¿Qué ocurre si se asigna o mapea una estética a algo diferente del nombre de una variable, como ser `aes(color = motor < 5)`?

<div class="solucion">
<h3>Solución</h3>

R crea una variable temporal que da cuenta de la evaluación de la variable. En el caso de `motor < 5` el resultado es verdadero o falso y según esto se incluyen los colores en el gráfico.

Ejemplo:
```{r ex.3.3.1.6}
ggplot(millas, aes(x = motor, y = autopista, colour = motor < 5)) +
  geom_point()
```
</div>

## Separar en facetas

### Ejercicios

1. Qué ocurre si intentas separar en facetas a una variable continua?

<div class="solucion">
<h3>Solución</h3>

Veamos un ejemplo:

```{r ex.3.5.1}
ggplot(millas, aes(x = cilindros, y = autopista)) +
  geom_point() +
  facet_grid(. ~ ciudad)
```

La variable continua es convertida a una variable categórica y el gráfico contiene una faceta para cada valor,
</div>

2. ¿Qué significan las celdas vacías que aparecen en el gráfico generado usando `facet_grid(traccion ~ cilindros)`?
¿Cómo se relacionan con este gráfico?

   ```{r, eval = FALSE}
   ggplot(data = millas) +
     geom_point(mapping = aes(x = traccion, y = cilindros))
   ```

<div class="solucion">
<h3>Solución</h3>

```{r}
ggplot(data = millas) +
  geom_point(mapping = aes(x = autopista, y = ciudad)) +
  facet_grid(traccion ~ cilindros)
```

Las celdas vacías (facetas) en este gráfico corresponden a combinaciones de `traccion`
y `cilindros` que no tienen observaciones.

Son las mismas ubicaciones en el gráfico de dispersión de `autopista` y `ciudad` que no
tienen gráfica.

```{r}
ggplot(data = millas) +
  geom_point(mapping = aes(x = autopista, y = ciudad))
```
</div>

3. ¿Qué gráfica el siguiente código? ¿Qué hace `.` ?

   ```{r eval = FALSE}
   ggplot(data = millas) +
     geom_point(mapping = aes(x = motor, y = autopista)) +
     facet_grid(traccion ~ .)
   
   ggplot(data = millas) +
     geom_point(mapping = aes(x = motor, y = autopista)) +
     facet_grid(. ~ cilindros)
   ```
   
<div class="solucion">
<h3>Solución</h3>

El símbolo `.` ignora la dimensión al momento de dibujar las facetas.
Por ejemplo, `autopista ~ .` divide por los valores de `autopista` en el eje y.

```{r ex.3.5.1.4.a}
ggplot(data = millas) +
  geom_point(mapping = aes(x = motor, y = autopista)) +
  facet_grid(traccion ~ .)
```

A la vez, `. ~ cilindrada` va a dividir por los valores de `cyl` en el eje x.

```{r ex.3.5.1.4.b}
ggplot(data = millas) +
  geom_point(mapping = aes(x = motor, y = autopista)) +
  facet_grid(. ~ cilindros)
```
</div>

4. Mira de nuevo el primer gráfico en facetas presentado en esta sección:

   ```{r, eval = FALSE}
   ggplot(data = millas) +
     geom_point(mapping = aes(x = motor, y = autopista)) +
     facet_wrap(~ clase, nrow = 2)
   ```

   ¿Cuáles son las ventajas de separar en facetas en lugar de aplicar una estética de color?
   ¿Cuáles son las desventajas?
   ¿Cómo cambiaría este balance si tuvieras un conjunto de datos más grande?

<div class="solucion">
<h3>Solución</h3>

En el siguiente gráfico muestra la variable `clase` como color.

```{r}
ggplot(data = millas) +
  geom_point(mapping = aes(x = motor, y = autopista, color = clase))
```

La ventaja de usar `clase` como parte de las facetas en lugar de un argumento de color
es la posibilidad de incluir distintas categorías.
Es difícil distinguir entre los colores de las categorías "mediano" y "minivan".

De acuerdo a las reglas de percepción, no se debería usar más de nueve colores para mostrar
información cualitativa.

Mostrar observaciones de distintas categorías en diferentes escalaes hace que sea difícil
comparar directamente entre los valores de distintas categorías.
Sin embargo, haría más fácil comparar la forma de la relación entre x e y en distintas
categorías.

La desventaja de usar `clase` para las facetas en lugar del argumento de color es la dificultad
de comparar valores entre categorías dado que las observaciones para cada categoría se ubican en
distintos gráficos.

Usando las mismas escalas para los ejes x e y en todas las facetas facilita comparar observaciones
entre categorías, pero sigue siendo una comparación más compleja respecto del caso en que todas
las observaciones se ubican en el mismo gráfico.
Dado que usar `clase` para el argumento de color sitúa todos los puntos en un mismo gráfico, muestra
la relación incondicional entre las variables x e y, lo que no ocurre al separar en distintos gráficos.

Los beneficios de codificar una variable mediante el color son crecientes si aumenta la cantidad de observaciones o el número de categorías. Si aumenta el número de categorías puede haber superposición y resulta complejo manejar esto con argumentos de color a menos que el número de observaciones sea pequeño y se pueda usar un argumento de distorsión (*jitter*).

El argumento de transparencia (*alpha*) no funciona bien con colores ya que la combinación de colores producto de la superposición no representa adecuadamente las categorías.

Si aumenta mucho el número de categorías va a ser cada vez más difícil contar con colores distintivos y será difícil distinguirlos.
</div>

5. Lee `?facet_wrap`. ¿Qué hace `nrow`? ¿Qué hace `ncol`?
¿Qué otras opciones controlan el diseño de los paneles individuales?
¿Por qué `facet_grid()` no tiene argumentos `nrow` y `ncol`?

<div class="solucion">
<h3>Solución</h3>

Los argumentos `nrow` y `ncol` determinan el número de filas y columnas al momento de generar
las facetas. `facet_wrap()` opera sobre una única variable. 

`nrow` y `ncol` no son necesarios con `facet_grid` ya que el número de valores únicos en la función determina el número de filas y columnas.
</div>

6. Cuando usas `facet_grid()`, generalmente deberías poner la variable con un mayor número de niveles únicos en las columnas. ¿Por qué?

<div class="solucion">
<h3>Solución</h3>

Hacerlo genera más espacio para las columnas si el gráfico se ubica de forma horizontal.
</div>

## Objetos geométricos


### Ejercicios

1. ¿Qué geom usarías para generar un gráfico de líneas?
¿Un diagrama de caja? ¿Un histograma? ¿Un gráfico de área?

<div class="solucion">
<h3>Solución</h3>

-   gráfico de líneas: `geom_line()`
-   diagrama de caja: `geom_boxplot()`
-   histograma: `geom_histogram()`
-   gráfico de área: `geom_area()`
</div>

2. Ejecuta este código en tu mente y predice cómo se verá el *output*.
Luego, ejecuta el código en R y verifica tus predicciones.

 ```{r, eval = FALSE}
   ggplot(data = millas, mapping = aes(x = motor, y = autopista, color = traccion)) +
     geom_point() +
     geom_smooth(se = FALSE)
 ```
 
<div class="solucion">
<h3>Solución</h3>

El resultado es un diagrama de dispersión con `motor` en el eje x, `autopista` en el eje y
y los puntos pintados de acuerdo a `traccion`.
También se incluirá una línea de tendencia, sin el error estándar, para cada grupo de `traccion`. 

```{r echo=TRUE}
ggplot(data = millas, mapping = aes(x = motor, y = autopista, colour = traccion)) +
  geom_point() +
  geom_smooth(se = FALSE)
```
</div>
 
3. ¿Qué muestra `show.legend = FALSE`? ¿Qué pasa si lo quitas?
 ¿Por qué crees que lo usé antes en el capítulo?

<div class="solucion">
<h3>Solución</h3>


`show.legend = FALSE` oculta la leyenda.

Considera el siguiente ejemplo ya visto:
```{r}
ggplot(data = millas) +
  geom_smooth(
    mapping = aes(x = cilindros, y = autopista, colour = traccion),
    show.legend = FALSE
  )
```


Quitar el argumento `show.legend` o definir `show.legend = TRUE` mostrará la relación entre `traccion` y la paleta de colores.

```{r}
ggplot(data = millas) +
  geom_smooth(mapping = aes(x = cilindros, y = autopista, colour = traccion))
```

In the chapter, the legend is suppressed because with three plots,
adding a legend to only the last plot would make the sizes of plots different.
Different sized plots would make it more difficult to see how arguments change the appearance of the plots.
The purpose of those plots is to show the difference between no groups, using a `group` aesthetic, and using a `color` aesthetic, which creates implicit groups.
In that example, the legend isn't necessary since looking up the values associated with each color isn't necessary to make that point.
</div>

4. ¿Qué hace el argumento `se` en `geom_smooth()`?

5. ¿Se verán distintos estos gráficos? ¿Por qué sí o por qué no?

   ```{r, eval = FALSE}
   ggplot(data = millas, mapping = aes(x = motor, y = autopista)) +
     geom_point() +
     geom_smooth()
   
   ggplot() +
     geom_point(data = millas, mapping = aes(x = motor, y = autopista)) +
     geom_smooth(data = millas, mapping = aes(x = motor, y = autopista))
   ```

6. Recrea el código R necesario para generar los siguientes gráficos:

   ```{r echo = FALSE, fig.width = 3, out.width = "50%", fig.align = "default", message = FALSE}
   ggplot(data = millas, mapping = aes(x = motor, y = autopista)) +
     geom_point() +
     geom_smooth(se = FALSE)
   
   ggplot(data = millas, mapping = aes(x = motor, y = autopista)) +
     geom_smooth(aes(group = traccion), se = FALSE) +
     geom_point()
   
   ggplot(data = millas, mapping = aes(x = motor, y = autopista, color = traccion)) +
     geom_point() +
     geom_smooth(se = FALSE)

   ggplot(data = millas, mapping = aes(x = motor, y = autopista)) +
     geom_point(aes(color = traccion)) +
     geom_smooth(se = FALSE)

   ggplot(data = millas, mapping = aes(x = motor, y = autopista)) +
     geom_point(aes(color = traccion)) +
     geom_smooth(aes(linetype = traccion), se = FALSE)
   
   ggplot(data = millas, mapping = aes(x = motor, y = autopista)) +
     geom_point(size = 4, colour = "white") +
     geom_point(aes(colour = traccion))
   ```

## Transformaciones estadísticas


### Ejercicios

1. ¿Cuál es el geom predeterminado asociado con `stat_summary()`?
¿Cómo podrías reescribir el gráfico anterior para usar esa función geom en lugar de la función stat?

2. ¿Qué hace `geom_col()`? ¿Cómo es diferente a `geom_bar()`?

3. La mayoría de los geoms y las estadísticas vienen en pares que casi siempre se usan en conjunto.
Lee la documentación y has una lista de todos los pares. ¿Qué tienen en común?

4. ¿Qué variables calcula `stat_smooth()`? ¿Qué parámetros controlan su comportamiento?

1. En nuestro gráfico de barras de proporción , necesitamos establecer `group = 1`. ¿Por qué?
En otras palabras, ¿cuál es el problema con estos dos gráficos?


   ```{r, eval = FALSE}
   ggplot(data = diamantes) +
     geom_bar(mapping = aes(x = corte, y = ..prop..))
   
   ggplot(data = diamantes) +
     geom_bar(mapping = aes(x = corte, fill = color, y = ..prop..))
   ```

## Ajustes de posición

### Ejercicios

1. ¿Cuál es el problema con este gráfico? ¿Cómo podrías mejorarlo?

   ```{r}
   ggplot(data = millas, mapping = aes(x = ciudad, y = autopista)) +
     geom_point()
   ```

2. ¿Qué parámetros de `geom_jitter()` controlan la cantidad de ruido?

3. Compara y contrasta `geom_jitter()` con `geom_count()`

4. ¿Cuál es el ajuste de posición predeterminado de `geom_boxplot()`? Crea una visualización del conjunto de datos de `millas` que lo demuestre.

## Sistemas de coordenadas


### Ejercicios

1. Convierte un gráfico de barras apiladas en un gráfico circular usando `coord_polar()`.

2. ¿Qué hace `labs()`? Lee la documentación.

3. ¿Cuál es la diferencia entre `coord_quickmap()` y `coord_map()`?

4. ¿Qué te dice la gráfica siguiente sobre la relación entre la ciudad y la `autopista`? ¿Por qué es `coord_fixed()` importante? ¿Qué hace `geom_abline()`?

   ```{r, fig.asp = 1, out.width = "50%"}
   ggplot(data = millas, mapping = aes(x = ciudad, y = autopista)) +
     geom_point() +
     geom_abline() +
     coord_fixed()
   ```
